<% @meta_title = "#{@project.url} summary" %>

<div class="container-sm">
  <h1>
    <% if @project.collection %>
      <%= link_to @project.collection, collection_path(@project.collection) %>:
    <% end %>
    <%= @project.url %>
  </h1>

  <p class="card-subtitle mb-2 text-muted"><i><small>
      Last synced: <%= distance_of_time_in_words_to_now @project.updated_at %> ago
  </small></i></p>
  
  <% if @project.repository %>
    <h2>
      Repository metadata: 
    </h2>

    <p>
      <%= @project.repository['description'] %>
    </p>

    <ul>
      <li>
        License: <%= @project.repository['license'] %>
      </li>
      <% if @project.repository['archived'] %>
      <li>
        Archived: <%= @project.repository['archived'] %>
      </li>
      <% end %>
      <% if @project.repository['fork'] %>
      <li>
        Fork: <%= @project.repository['fork'] %> (<%= @project.repository['source_name'] %>)
      </li>
      <% end %>
      <li>
        Created: <%= @project.repository['created_at'] %>
      </li>
      <li>
        Default Branch: <%= @project.repository['default_branch'] %>
      </li>
      <li>
        Last Pushed: <%= @project.repository['pushed_at'] %>
      </li>
      <li>
        Last Synced: <%= @project.repository['last_synced_at'] %> 
        (<%= distance_of_time_in_words_to_now @project.repository['last_synced_at'] %> ago)
        <% if @project.repository['latest_commit_sha'] %>
          (<%= @project.repository['latest_commit_sha'] %>)
        <% end %>
      </li>
      <% if @project.repository['topics'].any? %>
      <li>
        Topics: <%= @project.repository['topics'].join(', ') %>
      </li>
      <% end %>
      <li>
        Language: <%= @project.repository['language'] %>
      </li>
      <% if @project.repository['homepage'] %>
      <li>
        Homepage: <%= link_to @project.repository['homepage'], @project.repository['homepage'] %>
      </li>
      <% end %>
      <li>
        Size: <%= number_to_human_size @project.repository['size']*1000 %>
      </li>
      <li>
        Stars: <%= @project.repository['stargazers_count'] %>
      </li>
      <li>
        Watchers: <%= @project.repository['subscribers_count'] %>
      </li>
      <li>
        Forks: <%= @project.repository['forks_count'] %>
      </li>
      <li>
        Open Issues: <%= @project.repository['open_issues_count'] %>
      </li>
      <% if @project.repository['metadata'] && @project.repository['metadata']['files'] %>
      <li>
        Metadata Files:
        <ul>
          <% @project.repository['metadata']['files'].each do |k,v| %>
            <% next if v.blank? %>
            <li>
              <%= k.humanize %>: <%= v %>
            </li>
          <% end %>
        </ul>
      </li>
      <% end %>
    </ul>
  <% end %>


  <% if @project.packages %>
    <hr>
    <h2>
      Package metadata <span class='text-muted'><%= @project.packages.count %> packages</span>
    </h2>
    <% @project.packages.each do |package| %>
      <div class='card mb-3'>
        <div class="card-body pb-1">
          <div class="d-flex">
            <div class="flex-grow-1 ms-3 text-break">
              <h5 class='card-title'>
                <%= link_to package['registry']['name'], package['registry']['url'] %>: <%= link_to package['name'], package['registry_url'] %>
              </h5>

              <p class="card-subtitle mb-2 text-muted">
                <%= package['description'] %>
              </p>

              <ul>
                <li>
                  Homepage: <%= package['homepage'] %>
                </li>
                <% if package['documentation_url'].present? %>
                  <li>
                    Documentation: <%= link_to package['documentation_url'], package['documentation_url'] %>
                  </li>
                <% end %>
                <li>
                  Licenses: <%= package['licenses'] %>
                </li>
                <% if package['keywords'].present? %>
                <li>
                  Keywords: <%= package['keywords'] %>
                </li>
                <% end %>
                <li>
                  Latest release: <%= package['latest_release_number'] %> 
                  <% if package['latest_release_published_at'] %>
                    <i>
                      (published <%= distance_of_time_in_words_to_now package['latest_release_published_at'] %> ago)
                    </i>
                  <% end %>
                </li>
                <li>
                  Last Synced: <%= package['last_synced_at'] %> 
                  (<%= distance_of_time_in_words_to_now package['last_synced_at'] %> ago)
                </li>
                <li>
                  Versions: <%= package['versions_count'] %>
                </li>
                <li>
                  Dependent Packages: <%= package['dependent_packages_count'] %>
                </li>
                <li>
                  Dependent Repositories: <%= package['dependent_packages_count'] %>
                </li>
                <% if package['downloads'] %>
                <li>
                  Downloads: <%= package['downloads'] %> <%= package['downloads_period'].try(:humanize) %> 
                </li>
                <% end %>
                <li>
                  Rankings:
                  <ul>
                    <% package['rankings'].sort_by{|k,v| v.nil? ? 100 : v }.each do |k,v| %>
                      <% next if v.nil? %>
                      <li>
                        <%= k.humanize %>: <%= v.round(3) %>%
                      </li>
                    <% end%>
                  </ul>
                </li>
                <% if package['maintainers'].any? %>
                <li>
                  Maintainers (<%= package['maintainers'].length %>)
                  <ul>
                    <% package['maintainers'].each do |maintainer| %>
                      <li>
                        <%= link_to (maintainer['login'] || maintainer['uuid']), maintainer['html_url'] %>
                      </li>
                    <% end%>
                  </ul>
                </li>
                <% end%>
              </ul>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>

  <% if @project.commits %>
    <hr>
    <h2>
      Committers metadata
    </h2>

      <p class="card-subtitle mb-2 text-muted"><i><small>
        Last synced: <%= distance_of_time_in_words_to_now @project.commits['last_synced_at'] %> ago
    </small></i></p>
    <% if @project.commits['total_commits'] %>
      <p>
        Total Commits: <%= number_with_delimiter @project.commits['total_commits'] %><br>
        Total Committers: <%= number_with_delimiter @project.commits['total_committers'] %><br>
        Avg Commits per committer: <%= number_with_delimiter @project.commits['mean_commits'].round(3) %><br>
        Development Distribution Score (<a href='https://report.opensustain.tech/chapters/development-distribution-score.html' target="_blank">DDS</a>): <%= @project.commits['dds'].round(3) %><br/>
      </p>
    
    <table class='table'>
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Commits</th>
        </tr>
      </thead>
      <tbody>
        <% @project.commits['committers'].each do |committer| %>
          <tr>
            <td><%= committer['name'] %></td>
            <td><%= committer['email'] %></td>
            <td><%= committer['count'] %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
    <% end %>

  <% end %>

</div>